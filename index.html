<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaires de Prière | Prayer Times</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --glow-color: #00A9FF;
            --background-start: #010409;
            --background-end: #0B0014;
            --card-bg: rgba(13, 17, 23, 0.5);
            --card-border: rgba(48, 54, 61, 0.5);
            --text-primary: #E6EDF3;
            --text-secondary: #7D8590;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(145deg, var(--background-start), var(--background-end));
            color: var(--text-primary);
            overflow-y: auto;
        }
        
        #background-aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at top, rgba(0, 169, 255, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom, rgba(147, 51, 234, 0.15) 0%, transparent 50%);
            z-index: -1;
            animation: pulse-aurora 15s infinite alternate;
        }

        @keyframes pulse-aurora {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .prayer-card {
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }
        .prayer-card:before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 169, 255, 0.2), transparent);
            transition: 0.5s;
        }
        .prayer-card:hover:before {
            left: 100%;
        }
        .prayer-card:hover {
            border-color: var(--glow-color);
            transform: translateY(-8px);
            box-shadow: 0 0 25px rgba(0, 169, 255, 0.2);
        }

        .next-prayer-glow {
            border-color: var(--glow-color);
            box-shadow: 0 0 15px var(--glow-color), 0 0 30px var(--glow-color), inset 0 0 10px rgba(0, 169, 255, 0.3);
            transform: translateY(-8px) scale(1.02);
        }
        .next-prayer-glow .prayer-time, .next-prayer-glow h3 {
            color: var(--glow-color);
            text-shadow: 0 0 10px var(--glow-color);
        }

        .prayer-time { color: var(--text-primary); }

        .loader {
            border: 4px solid #30363D; border-left-color: var(--glow-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #settings-modal, #location-modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        #settings-modal.hidden, #location-modal.hidden { visibility: hidden; opacity: 0; }
        #settings-modal:not(.hidden) .modal-content, #location-modal:not(.hidden) .modal-content { transform: translateY(0); box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        
        .modal-input {
            background-color: var(--background-start);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }
        .modal-input:focus {
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 169, 255, 0.3);
            outline: none;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        
    </style>
</head>
<body class="antialiased">

    <div id="background-aurora"></div>

    <div id="main-content" class="relative z-10 min-h-screen flex flex-col items-center justify-center p-4 opacity-0 transition-opacity duration-1000">
        
        <header class="text-center mb-8 w-full max-w-7xl relative fade-in-up">
            <h1 id="current-date" class="text-lg md:text-xl font-light text-gray-400">--</h1>
            <p id="hijri-date" class="text-sm font-light text-gray-500 mb-2">--</p>
            <div id="location-wrapper" class="relative group">
                <p id="location-btn" class="text-2xl md:text-4xl font-bold tracking-wider text-white cursor-pointer group-hover:text-cyan-300 transition-colors duration-300 inline-flex items-center gap-3">
                    <i data-feather="map-pin" class="h-6 w-6 -mt-1"></i> 
                    <span id="location-text">Recherche en cours...</span>
                    <i data-feather="edit-2" class="h-5 w-5 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                </p>
            </div>
            <button id="settings-btn" class="absolute top-0 right-0 p-3 text-gray-400 hover:text-cyan-300 transition-colors duration-300">
                <i data-feather="settings" class="h-6 w-6"></i>
            </button>
        </header>

        <div id="prayer-times-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-5 md:gap-6 w-full max-w-7xl mb-8"></div>

        <div class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 text-center">
            <!-- Next Prayer -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6 flex flex-col justify-center fade-in-up" style="animation-delay: 0.3s;">
                <h2 class="text-lg font-semibold text-gray-300 mb-2 tracking-widest">PROCHAINE PRIÈRE</h2>
                <div id="countdown" class="text-5xl md:text-6xl font-bold text-white tracking-wider">
                    <span id="countdown-hours">00</span>:<span id="countdown-minutes">00</span>:<span id="countdown-seconds">00</span>
                </div>
                <p id="next-prayer-name" class="mt-2 text-xl font-light text-cyan-300 tracking-wider">--</p>
            </div>
            
            <!-- Tasbih Counter -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6 flex flex-col justify-center text-center fade-in-up" style="animation-delay: 0.4s;">
                <div class="flex justify-between items-center w-full mb-3">
                    <h2 class="text-lg font-semibold text-gray-300 tracking-widest">TASBIH</h2>
                    <button id="tasbih-reset-btn" class="p-2 text-gray-400 hover:text-red-400 transition-colors duration-300" title="Réinitialiser">
                        <i data-feather="refresh-cw" class="h-5 w-5"></i>
                    </button>
                </div>
                <p id="tasbih-count" class="text-7xl font-bold text-white tracking-wider cursor-pointer select-none" title="Cliquez pour compter">0</p>
                <div class="w-full text-xs text-gray-500 mt-2">Cliquez sur le nombre pour compter</div>
            </div>

            <!-- Verse of the Day -->
            <div class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in-up" style="animation-delay: 0.5s;">
                <h2 class="text-lg font-semibold text-gray-300 mb-3 tracking-widest">VERSET DU JOUR</h2>
                <div class="flex-grow flex flex-col justify-center min-h-[80px]">
                    <p id="verse-text" class="text-base text-gray-200 italic">--</p>
                    <p id="verse-source" class="text-sm text-cyan-400 mt-2">--</p>
                </div>
            </div>

            <!-- Hadith of the Day -->
            <div class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in-up" style="animation-delay: 0.6s;">
                <h2 class="text-lg font-semibold text-gray-300 mb-3 tracking-widest">HADITH DU JOUR</h2>
                <div class="flex-grow flex flex-col justify-center min-h-[80px]">
                    <p id="hadith-text" class="text-base text-gray-200 italic">--</p>
                    <p id="hadith-source" class="text-sm text-cyan-400 mt-2">--</p>
                </div>
            </div>

            <!-- Name of Allah -->
            <div class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in-up" style="animation-delay: 0.7s;">
                <h2 class="text-lg font-semibold text-gray-300 mb-3 tracking-widest">NOM D'ALLAH</h2>
                <div class="flex-grow flex flex-col justify-center min-h-[80px]">
                     <p id="asma-name" class="text-2xl font-bold text-cyan-300">--</p>
                     <p id="asma-meaning" class="text-base text-white mt-1">--</p>
                </div>
            </div>

            <!-- Upcoming Islamic Event -->
            <div class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in-up" style="animation-delay: 0.8s;">
                <h2 class="text-lg font-semibold text-gray-300 mb-3 tracking-widest">PROCHAIN ÉVÉNEMENT</h2>
                <div class="flex-grow flex flex-col justify-center min-h-[80px]">
                     <p id="event-name" class="text-xl font-bold text-cyan-300">--</p>
                     <p id="event-countdown" class="text-lg text-white mt-1">--</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-lg font-semibold text-gray-300">Obtention des heures de prière...</p>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="modal-content glass-card rounded-2xl p-8 w-full max-w-md transform -translate-y-10">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Paramètres</h2><button id="close-settings-btn" class="p-1 text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div>
            <div>
                <label for="calculation-method" class="block mb-2 text-sm font-medium text-gray-300">Méthode de calcul</label>
                <select id="calculation-method" class="w-full modal-input text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-3"></select>
            </div>
        </div>
    </div>

    <div id="location-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="modal-content glass-card rounded-2xl p-8 w-full max-w-md transform -translate-y-10">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Changer de lieu</h2><button id="close-location-btn" class="p-1 text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div>
            <div>
                <label for="location-search-input" class="block mb-2 text-sm font-medium text-gray-300">Entrez le nom d'une ville</label>
                <input type="text" id="location-search-input" class="w-full modal-input text-lg rounded-lg p-3" placeholder="Ex: Paris, France">
                <p class="text-xs text-gray-500 mt-2">Appuyez sur "Entrée" pour valider.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PRAYER_NAMES = { Fajr: "Fajr", Sunrise: "Shuruq", Dhuhr: "Dhuhr", Asr: "Asr", Maghrib: "Maghrib", Isha: "Isha" };
            const PRAYER_ICONS = { Fajr: "sunrise", Sunrise: "sun", Dhuhr: "sun", Asr: "sunset", Maghrib: "moon", Isha: "moon" };
            const FALLBACK_COORDS = { latitude: -12.8275, longitude: 45.166244 }; // Coordonnées pour Mayotte
            const HIJRI_MONTHS_FR = { "Muḥarram": "Mouharram", "Ṣafar": "Safar", "Rabīʿ al-awwal": "Rabi' al-awwal", "Rabīʿ ath-thānī": "Rabi' al-thani", "Jumādá al-ūlá": "Joumada al-oula", "Jumādá al-ākhirah": "Joumada al-akhira", "Rajab": "Rajab", "Shaʿbān": "Chaabane", "Ramaḍān": "Ramadan", "Shawwāl": "Chawwal", "Dhū al-Qaʿdah": "Dhou al qi'da", "Dhū al-Ḥijjah": "Dhou al-hijja" };
            const CALCULATION_METHODS = { '3': 'Ligue Islamique Mondiale', '4': 'Umm Al-Qura, Makkah', '2': 'Société Islamique d\'Amérique du Nord (ISNA)', '12': 'Union des Organisations Islamiques de France (UOIF)', '5': 'Autorité générale égyptienne de l\'enquête', '7': 'Institut de géophysique, Université de Téhéran', '15': 'Moonsighting Committee Worldwide' };
            const VERSES = [
                { text: "Allah n'impose à aucune âme une charge supérieure à sa capacité.", source: "Coran 2:286" },
                { text: "Et quiconque craint Allah, Il lui donnera une issue favorable.", source: "Coran 65:2" },
                { text: "En vérité, avec la difficulté vient la facilité.", source: "Coran 94:6" },
                { text: "Et c'est en Allah que les croyants doivent placer leur confiance.", source: "Coran 3:122" },
                { text: "Les bonnes œuvres effacent les mauvaises.", source: "Coran 11:114" },
                { text: "Et soyez patients. Assurément, Allah est avec les patients.", source: "Coran 8:46" },
                { text: "Appelez-Moi, Je vous répondrai.", source: "Coran 40:60" },
                { text: "Et ne désespérez pas de la miséricorde d'Allah.", source: "Coran 39:53" },
                { text: "En vérité, le rappel d'Allah est le plus grand.", source: "Coran 29:45" },
                { text: "Celui qui fait un atome de bien le verra.", source: "Coran 99:7" }
            ];
            const HADITHS = [
                { text: "Celui qui n'est pas miséricordieux envers les autres ne sera pas traité avec miséricorde.", source: "Sahih al-Bukhari" },
                { text: "La richesse ne consiste pas à posséder beaucoup de biens, mais la richesse, c'est d'être content de soi-même.", source: "Sahih Muslim" },
                { text: "L'homme fort n'est pas le bon lutteur ; l'homme fort n'est que celui qui se maîtrise quand il est en colère.", source: "Sahih al-Bukhari" },
                { text: "Les meilleures personnes parmi vous sont celles qui ont les meilleures mœurs et le meilleur caractère.", source: "Sahih al-Bukhari" },
                { text: "Facilitez les choses aux gens, et ne les rendez pas difficiles.", source: "Sahih al-Bukhari" },
                { text: "Aucun de vous ne croit vraiment tant qu'il ne désire pas pour son frère ce qu'il désire pour lui-même.", source: "Sahih al-Bukhari" }
            ];
            const ASMAUL_HUSNA = [
                { name: "Ar-Rahman", meaning: "Le Tout-Miséricordieux" }, { name: "Ar-Rahim", meaning: "Le Très-Miséricordieux" }, { name: "Al-Malik", meaning: "Le Souverain" },
                { name: "Al-Quddus", meaning: "Le Saint" }, { name: "As-Salam", meaning: "La Paix" }, { name: "Al-Mu'min", meaning: "Le Fidèle" },
                { name: "Al-Muhaymin", meaning: "Le Dominateur" }, { name: "Al-Aziz", meaning: "Le Tout-Puissant" }, { name: "Al-Jabbar", meaning: "Celui qui contraint" },
                { name: "Al-Mutakabbir", meaning: "Le Superbe" }, { name: "Al-Khaliq", meaning: "Le Créateur" }, { name: "Al-Bari'", meaning: "Le Producteur" }
            ];
            const ISLAMIC_EVENTS = [
                { name: "Début du Ramadan", date: "2025-02-28" },
                { name: "Aïd al-Fitr", date: "2025-03-30" },
                { name: "Jour de Arafat", date: "2025-06-05" },
                { name: "Aïd al-Adha", date: "2025-06-06" },
                { name: "Nouvel An Islamique", date: "2025-06-26" },
                { name: "Achoura", date: "2025-07-05" },
                { name: "Mawlid an-Nabi", date: "2025-09-04" },
                { name: "Début du Ramadan", date: "2026-02-17" },
                { name: "Aïd al-Fitr", date: "2026-03-20" },
            ];

            let prayerTimesData = {}, countdownInterval, currentCoords;
            let calculationMethod = localStorage.getItem('calculationMethod') || '12';

            const elements = {
                mainContent: document.getElementById('main-content'), loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'),
                locationBtn: document.getElementById('location-btn'), locationText: document.getElementById('location-text'), locationSearchInput: document.getElementById('location-search-input'),
                dateEl: document.getElementById('current-date'), hijriDateEl: document.getElementById('hijri-date'), gridEl: document.getElementById('prayer-times-grid'),
                countdownHoursEl: document.getElementById('countdown-hours'), countdownMinutesEl: document.getElementById('countdown-minutes'), countdownSecondsEl: document.getElementById('countdown-seconds'),
                nextPrayerNameEl: document.getElementById('next-prayer-name'), 
                settingsModal: document.getElementById('settings-modal'), settingsBtn: document.getElementById('settings-btn'), closeSettingsBtn: document.getElementById('close-settings-btn'), methodSelect: document.getElementById('calculation-method'),
                locationModal: document.getElementById('location-modal'), closeLocationBtn: document.getElementById('close-location-btn'),
                verseText: document.getElementById('verse-text'), verseSource: document.getElementById('verse-source'),
                hadithText: document.getElementById('hadith-text'), hadithSource: document.getElementById('hadith-source'),
                asmaName: document.getElementById('asma-name'), asmaMeaning: document.getElementById('asma-meaning'),
                eventName: document.getElementById('event-name'), eventCountdown: document.getElementById('event-countdown'),
                tasbihCount: document.getElementById('tasbih-count'), tasbihResetBtn: document.getElementById('tasbih-reset-btn'),
            };

            const initIcons = () => feather.replace();

            function initModals() {
                Object.entries(CALCULATION_METHODS).forEach(([id, name]) => {
                    const option = new Option(name, id);
                    if (id === calculationMethod) option.selected = true;
                    elements.methodSelect.add(option);
                });
                elements.settingsBtn.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
                elements.closeSettingsBtn.addEventListener('click', () => elements.settingsModal.classList.add('hidden'));
                elements.settingsModal.addEventListener('click', (e) => { if (e.target === elements.settingsModal) elements.settingsModal.classList.add('hidden'); });
                elements.methodSelect.addEventListener('change', (e) => {
                    calculationMethod = e.target.value;
                    localStorage.setItem('calculationMethod', calculationMethod);
                    elements.settingsModal.classList.add('hidden');
                    fetchAndDisplayData(currentCoords);
                });

                elements.locationBtn.addEventListener('click', () => {
                    elements.locationModal.classList.remove('hidden');
                    elements.locationSearchInput.focus();
                });
                elements.closeLocationBtn.addEventListener('click', () => elements.locationModal.classList.add('hidden'));
                elements.locationModal.addEventListener('click', (e) => { if (e.target === elements.locationModal) elements.locationModal.classList.add('hidden'); });
                elements.locationSearchInput.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const query = elements.locationSearchInput.value.trim();
                        if (query) {
                            elements.locationModal.classList.add('hidden');
                            elements.loaderText.textContent = `Recherche de "${query}"...`;
                            elements.loader.style.display = 'flex';
                            try {
                                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&accept-language=fr`);
                                const geoData = await geoResponse.json();
                                if (geoData.length > 0) {
                                    const { lat, lon } = geoData[0];
                                    const manualCoords = { latitude: parseFloat(lat), longitude: parseFloat(lon) };
                                    localStorage.setItem('manualCoords', JSON.stringify(manualCoords));
                                    currentCoords = manualCoords;
                                    await fetchAndDisplayData(currentCoords);
                                } else { alert("Ville non trouvée."); }
                            } catch (error) { console.error("Erreur de recherche:", error); alert("Erreur lors de la recherche."); }
                        }
                    }
                });
            }

            async function fetchAPI(url) {
                const response = await fetch(url);
                if (response.ok) return response.json();
                return Promise.reject(response.status);
            }
            
            function getUserLocation() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) return resolve(FALLBACK_COORDS);
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                        () => {
                            elements.loaderText.innerHTML = `<span class="text-yellow-400">Localisation refusée.</span><br><span class="text-sm">Position par défaut active.</span>`;
                            resolve(FALLBACK_COORDS);
                        }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                    );
                });
            }

            const padZero = (num) => num.toString().padStart(2, '0');

            function updateCountdown() {
                const now = new Date();
                const sortedPrayers = Object.entries(prayerTimesData)
                    .filter(([name]) => PRAYER_NAMES.hasOwnProperty(name) && name !== 'Sunrise')
                    .map(([name, time]) => {
                        const [h, m] = time.split(':');
                        return { name, date: new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m) };
                    }).sort((a, b) => a.date - b.date);

                let nextPrayer = sortedPrayers.find(p => p.date > now);
                if (!nextPrayer) {
                    nextPrayer = sortedPrayers[0];
                    if (nextPrayer) {
                       nextPrayer.date.setDate(nextPrayer.date.getDate() + 1);
                    } else { return; }
                }

                const diff = nextPrayer.date - now;
                elements.countdownHoursEl.textContent = padZero(Math.floor(diff / 3600000));
                elements.countdownMinutesEl.textContent = padZero(Math.floor((diff % 3600000) / 60000));
                elements.countdownSecondsEl.textContent = padZero(Math.floor((diff % 60000) / 1000));
                elements.nextPrayerNameEl.textContent = PRAYER_NAMES[nextPrayer.name];

                document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('next-prayer-glow'));
                document.getElementById(`prayer-${nextPrayer.name}`)?.classList.add('next-prayer-glow');
            }
            
            function getDayOfYear() {
                return Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            }

            function displayDailyVerse() {
                const verse = VERSES[getDayOfYear() % VERSES.length];
                elements.verseText.textContent = `"${verse.text}"`;
                elements.verseSource.textContent = verse.source;
            }

            function displayDailyHadith() {
                const hadith = HADITHS[getDayOfYear() % HADITHS.length];
                elements.hadithText.textContent = `"${hadith.text}"`;
                elements.hadithSource.textContent = hadith.source;
            }

            function displayDailyNameOfAllah() {
                const asma = ASMAUL_HUSNA[getDayOfYear() % ASMAUL_HUSNA.length];
                elements.asmaName.textContent = asma.name;
                elements.asmaMeaning.textContent = asma.meaning;
            }

            function displayNextIslamicEvent() {
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                const nextEvent = ISLAMIC_EVENTS
                    .map(event => ({ ...event, dateObj: new Date(event.date + 'T00:00:00') }))
                    .find(event => event.dateObj >= now);

                if (nextEvent) {
                    const diffTime = nextEvent.dateObj - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    elements.eventName.textContent = nextEvent.name;
                    if (diffDays === 0) {
                        elements.eventCountdown.textContent = `Aujourd'hui`;
                    } else if (diffDays === 1) {
                         elements.eventCountdown.textContent = `Demain`;
                    } else {
                        elements.eventCountdown.textContent = `Dans ${diffDays} jours`;
                    }
                } else {
                    elements.eventName.textContent = "Aucun événement proche";
                    elements.eventCountdown.textContent = "Veuillez consulter plus tard";
                }
            }

            function initTasbih() {
                let count = parseInt(localStorage.getItem('tasbihCount') || '0');
                elements.tasbihCount.textContent = count;

                const updateTasbih = (newCount) => {
                    count = newCount;
                    localStorage.setItem('tasbihCount', count);
                    elements.tasbihCount.textContent = count;
                };

                elements.tasbihCount.addEventListener('click', () => {
                    updateTasbih(count + 1);
                });

                elements.tasbihResetBtn.addEventListener('click', () => {
                    updateTasbih(0);
                });
            }

            async function fetchAndDisplayData(coords) {
                elements.loader.style.display = 'flex';
                elements.mainContent.classList.remove('opacity-100');
                try {
                    const { latitude, longitude } = coords;
                    currentCoords = coords; 
                    let locationName = "Lieu par défaut";
                    try {
                        const geoResponse = await fetchAPI(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=fr`);
                        const { city, town, village, county, country } = geoResponse.address;
                        locationName = `${city || town || village || county || 'Lieu inconnu'}, ${country}`;
                    } catch (e) { console.warn("Could not fetch location name.", e); }

                    const prayerTimesURL = `https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${latitude}&longitude=${longitude}&method=${calculationMethod}`;
                    const prayerResponse = await fetchAPI(prayerTimesURL);

                    const prayerData = prayerResponse.data;
                    prayerTimesData = prayerData.timings;
                    elements.gridEl.innerHTML = Object.keys(PRAYER_NAMES).map((key, index) => {
                        const [h, m] = prayerData.timings[key].split(':');
                        const time = new Date(1970, 0, 1, h, m).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', hour12: false });
                        return `<div id="prayer-${key}" class="prayer-card glass-card rounded-2xl p-4 text-center fade-in-up" style="animation-delay: ${index * 100}ms;">
                                    <i data-feather="${PRAYER_ICONS[key]}" class="mx-auto h-8 w-8 text-gray-400 mb-3"></i>
                                    <h3 class="text-lg font-semibold">${PRAYER_NAMES[key]}</h3>
                                    <p class="text-2xl font-bold prayer-time mt-1">${time}</p>
                                </div>`;
                    }).join('');

                    elements.locationText.textContent = locationName;
                    elements.dateEl.textContent = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    const hijri = prayerData.date.hijri;
                    elements.hijriDateEl.textContent = `${hijri.day} ${HIJRI_MONTHS_FR[hijri.month.en] || hijri.month.en} ${hijri.year} AH`;
                    
                    displayDailyVerse();
                    displayDailyHadith();
                    displayDailyNameOfAllah();
                    displayNextIslamicEvent();

                    if (countdownInterval) clearInterval(countdownInterval);
                    updateCountdown();
                    countdownInterval = setInterval(updateCountdown, 1000);
                    
                    elements.mainContent.classList.add('opacity-100');
                    initIcons();
                } catch (error) {
                    console.error("Failed to fetch and display data:", error);
                    elements.loaderText.innerHTML = `<span class="text-red-400">Erreur de chargement.</span><br><span class="text-sm">Veuillez vérifier votre connexion.</span>`;
                } finally {
                    elements.loader.style.display = 'none';
                }
            }

            async function main() {
                initModals();
                initTasbih();
                const savedCoords = localStorage.getItem('manualCoords');
                currentCoords = savedCoords ? JSON.parse(savedCoords) : await getUserLocation();
                await fetchAndDisplayData(currentCoords);
            }

            main();
        });
    </script>
</body>
</html>

